# iOS 设备通讯录同步功能说明

## 功能概述

本项目通过 libimobiledevice 的 `mobilesync` 服务实现了从 iOS 设备读取通讯录的功能。使用 Apple 的数据同步协议，可以安全地访问设备上的联系人信息。

## 技术实现

### 1. 核心组件

#### ContactManager (`src/core/contact/contactmanager.h/cpp`)
通讯录管理核心类，负责：
- 与 iOS 设备建立 mobilesync 连接
- 执行通讯录数据同步
- 解析联系人数据（plist 格式）
- 提供搜索和导出功能

#### ContactPage (`src/ui/contactpage.h/cpp/ui`)
通讯录界面页面，提供：
- 同步按钮触发通讯录获取
- 搜索框过滤联系人
- 表格显示联系人列表
- 详细信息查看区域
- 导出为 vCard 功能

#### mobilesync_dynamic.h (`src/platform/mobilesync_dynamic.h`)
动态加载 mobilesync API 的函数指针定义

### 2. 同步流程

```
1. 用户点击"同步通讯录"按钮
   ↓
2. ContactManager::syncContacts() 启动
   ↓
3. 建立 lockdown 客户端连接
   ↓
4. 启动 mobilesync 服务
   mobilesync_client_start_service()
   ↓
5. 开始同步会话
   mobilesync_start(client, "com.apple.Contacts", ...)
   ↓
6. 请求所有通讯录记录
   mobilesync_get_all_records_from_device()
   ↓
7. 循环接收数据
   mobilesync_receive_changes() - 接收 plist 数据
   ↓
8. 解析联系人信息
   parseContactFromPlist() - 解析为 Contact 结构
   ↓
9. 确认接收并完成同步
   mobilesync_acknowledge_changes_from_device()
   mobilesync_finish()
   ↓
10. 在 UI 上显示联系人列表
```

### 3. 数据结构

#### Contact 结构
```cpp
struct Contact {
    QString id;              // 联系人唯一ID
    QString firstName;       // 名
    QString lastName;        // 姓
    QStringList phoneNumbers; // 电话号码列表
    QStringList emails;      // 电子邮件列表
    QString organization;    // 组织/公司
    QString note;           // 备注
};
```

### 4. 支持的联系人字段

从 iOS 设备同步的联系人数据包含以下字段：
- **姓名**: First (名)、Last (姓)
- **电话**: Phone (可能包含多个号码)
- **邮箱**: Email (可能包含多个地址)
- **组织**: Organization
- **备注**: Note

## 使用方法

### 1. 基本操作

1. **连接设备**: 点击主界面的"连接设备"按钮，选择 iOS 设备
2. **打开通讯录页面**: 在左侧菜单选择"通讯录"
3. **同步通讯录**: 点击"同步通讯录"按钮，等待同步完成
4. **查看联系人**: 同步完成后，联系人列表将显示在表格中

### 2. 搜索联系人

在搜索框中输入关键词，可以实时过滤联系人列表。搜索支持：
- 姓名匹配
- 电话号码匹配
- 邮箱匹配
- 组织名称匹配

### 3. 查看详情

点击表格中的任意联系人，右侧详情区域将显示该联系人的完整信息。

### 4. 导出通讯录

1. 点击"导出为 vCard"按钮
2. 选择保存位置
3. 所有联系人将导出为标准 vCard (.vcf) 格式文件

## API 参考

### mobilesync 关键函数

#### 1. 启动服务
```cpp
mobilesync_error_t mobilesync_client_start_service(
    idevice_t device,
    mobilesync_client_t* client,
    const char* label
);
```

#### 2. 开始同步会话
```cpp
mobilesync_error_t mobilesync_start(
    mobilesync_client_t client,
    const char* data_class,  // "com.apple.Contacts"
    mobilesync_anchors_t anchors,
    uint64_t computer_data_class_version,
    mobilesync_sync_type_t* sync_type,
    uint64_t* device_data_class_version,
    char** error_description
);
```

#### 3. 请求所有记录
```cpp
mobilesync_error_t mobilesync_get_all_records_from_device(
    mobilesync_client_t client
);
```

#### 4. 接收变更
```cpp
mobilesync_error_t mobilesync_receive_changes(
    mobilesync_client_t client,
    plist_t* entities,
    uint8_t* is_last_record,
    plist_t* actions
);
```

#### 5. 确认变更
```cpp
mobilesync_error_t mobilesync_acknowledge_changes_from_device(
    mobilesync_client_t client
);
```

#### 6. 完成同步
```cpp
mobilesync_error_t mobilesync_finish(
    mobilesync_client_t client
);
```

## 数据类标识符

mobilesync 服务支持多种数据类，通讯录使用：
```cpp
"com.apple.Contacts"  // 通讯录数据类
```

其他可用的数据类：
- `"com.apple.Calendars"` - 日历
- `"com.apple.Bookmarks"` - 书签
- `"com.apple.Notes"` - 备忘录

## 注意事项

### 1. 设备要求
- iOS 设备必须解锁
- 设备必须信任此电脑
- 需要配对成功

### 2. 性能考虑
- 大量联系人（>1000）可能需要较长同步时间
- 同步过程在后台线程执行，不会阻塞 UI
- 进度条显示同步进度

### 3. 错误处理
常见错误及解决方法：
- **连接失败**: 检查设备是否解锁，USB 连接是否正常
- **权限错误**: 确保设备已信任此电脑
- **服务启动失败**: 重启设备或重新配对

### 4. 数据格式
- 联系人数据以 plist 格式从设备传输
- 内部使用 Qt 的数据结构存储
- 导出为标准 vCard 3.0 格式

## 文件清单

### 新增文件
```
src/core/contact/
├── contactmanager.h          # ContactManager 类定义
└── contactmanager.cpp        # ContactManager 实现

src/ui/
├── contactpage.h             # ContactPage 界面定义
├── contactpage.cpp           # ContactPage 实现
└── contactpage.ui            # ContactPage UI 布局

src/platform/
└── mobilesync_dynamic.h      # mobilesync API 动态加载定义
```

### 修改文件
```
src/ui/
├── mainwindow.h              # 添加 ContactManager 成员
├── mainwindow.cpp            # 集成通讯录页面
└── mainwindow.ui             # 添加 ContactPage widget

src/platform/
├── libimobiledevice_dynamic.h   # 添加 mobilesync 函数指针
└── libimobiledevice_dynamic.cpp # 加载 mobilesync 函数

CMakeLists.txt                # 添加新源文件到构建
```

## 编译说明

### Windows
```bash
cd phone-linkc
mkdir build
cd build
cmake ..
cmake --build . --config Debug
```

### macOS/Linux
```bash
cd phone-linkc
mkdir build
cd build
cmake ..
make
```

## 测试建议

1. **基本同步测试**
   - 连接包含少量联系人的设备
   - 验证所有字段正确显示

2. **大数据测试**
   - 连接包含大量联系人（>500）的设备
   - 验证同步性能和内存使用

3. **搜索测试**
   - 测试各种搜索关键词
   - 验证实时过滤功能

4. **导出测试**
   - 导出通讯录为 vCard
   - 在其他应用中导入验证

## 未来改进方向

1. **增量同步**: 使用 sync anchors 实现增量同步，只获取变更的联系人
2. **双向同步**: 支持将修改同步回设备（需要额外的权限处理）
3. **分组支持**: 解析并显示联系人分组信息
4. **照片支持**: 同步联系人头像照片
5. **更多字段**: 支持地址、生日、社交账号等更多字段

## 参考资料

- [libimobiledevice 官方文档](https://libimobiledevice.org/)
- [mobilesync API 参考](https://docs.libimobiledevice.org/mobilesync_8h.html)
- [vCard 3.0 规范](https://tools.ietf.org/html/rfc2426)